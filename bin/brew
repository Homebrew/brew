#!/bin/bash -pu
set -u

# Fail fast with concise message when not using bash
# Single brackets is needed here for POSIX compatibility
# shellcheck disable=SC2292
if [ -z "${BASH_VERSION:-}" ]
then
  echo "Ошибка: Bash требуется для запуска brew." >&2
  exit 1
fi

set +o posix # as we are using bash now

# Fail fast with concise messages when PWD has issues
if [[ -z "${PWD-}" ]]
then
  echo "Ошибка: \$PWD должен быть установлен для запуска brew." >&2
  exit 1
fi
if ! [[ -d "${PWD}" ]]
then
  echo "Ошибка: Должна существовать текущая рабочая директория для запуска brew." >&2
  exit 1
fi
if ! [[ -r "${PWD}" ]]
then
  echo "Ошибка: Текущая рабочая директория должна быть читабильной для ${USER} для запуска brew." >&2
  exit 1
fi

# Fail fast with concise message when HOME is unset
if [[ -z "${HOME:-}" ]]
then
  echo "Ошибка: \$HOME должен быть установлен для запуска brew." >&2
  exit 1
fi

quiet_cd() {
  CDPATH='' cd -- "$@" &>/dev/null || return
}

symlink_target_directory() {
  local target target_dirname
  target="$(readlink "$1")"
  target_dirname="$(dirname "${target}")"
  local directory="$2"
  quiet_cd "${directory}" && quiet_cd "${target_dirname}" && pwd -P
}

# Enable and use default Bash builtins rather than user-defined functions
builtin enable compgen unset
for cmd in $(builtin compgen -A builtin)
do
  builtin unset -f "${cmd}"
  builtin enable "${cmd}"
done
unset cmd

# Avoid picking up any random `sudo` in `PATH`.
if [[ -x /usr/bin/sudo ]]
then
  SUDO=/usr/bin/sudo
else
  # Do this after ensuring we're using default Bash builtins.
  SUDO="$(command -v sudo 2>/dev/null)"
fi

# Reset sudo timestamp to avoid running unauthorized sudo commands
if [[ -n "${SUDO}" ]]
then
  "${SUDO}" --reset-timestamp 2>/dev/null || true
fi
unset SUDO

# Take the DINRUSBREW_PATH if we are running brew within brew, otherwise we would lose the original path.
if [[ -n "${DINRUSBREW_BREW_FILE:-}" && -n "${DINRUSBREW_PATH:-}" ]]
then
  PATH="${DINRUSBREW_PATH}"
fi

BREW_FILE_DIRECTORY="$(quiet_cd "${0%/*}/" && pwd -P)"
DINRUSBREW_BREW_FILE="${BREW_FILE_DIRECTORY%/}/${0##*/}"
DINRUSBREW_PREFIX="${DINRUSBREW_BREW_FILE%/*/*}"

# Default to / prefix if unset or the bin/brew file.
if [[ -z "${DINRUSBREW_PREFIX}" || "${DINRUSBREW_PREFIX}" = "${DINRUSBREW_BREW_FILE}" ]]
then
  DINRUSBREW_PREFIX="/"
fi

DINRUSBREW_REPOSITORY="${DINRUSBREW_PREFIX}"

# Resolve the bin/brew symlink to find DinrusBrew's repository
if [[ -L "${DINRUSBREW_BREW_FILE}" ]]
then
  BREW_FILE_DIRECTORY="$(symlink_target_directory "${DINRUSBREW_BREW_FILE}" "${BREW_FILE_DIRECTORY}")"
  DINRUSBREW_REPOSITORY="${BREW_FILE_DIRECTORY%/*}"
fi

# Try to find a /usr/local DINRUSBREW_PREFIX where possible (for macOS x86_64 bottles)
if [[ -L "/usr/local/bin/brew" && ! -L "${DINRUSBREW_PREFIX}/Cellar" ]]
then
  USR_LOCAL_BREW_FILE_DIRECTORY="$(symlink_target_directory "/usr/local/bin/brew" "/usr/local/bin")"
  USR_LOCAL_DINRUSBREW_REPOSITORY="${USR_LOCAL_BREW_FILE_DIRECTORY%/*}"
  if [[ "${DINRUSBREW_REPOSITORY}" = "${USR_LOCAL_DINRUSBREW_REPOSITORY}" ]]
  then
    DINRUSBREW_PREFIX="/usr/local"
  fi
  unset USR_LOCAL_BREW_FILE_DIRECTORY USR_LOCAL_DINRUSBREW_REPOSITORY
fi

unset BREW_FILE_DIRECTORY

# If the location of DINRUSBREW_LIBRARY changes
# keg_relocate.rb, formula_cellar_checks.rb, and test/global_spec.rb need to change.
DINRUSBREW_LIBRARY="${DINRUSBREW_REPOSITORY}/Library"

# Use DINRUSBREW_BREW_WRAPPER if set.
export DINRUSBREW_ORIGINAL_BREW_FILE="${DINRUSBREW_BREW_FILE}"
if [[ -n "${DINRUSBREW_BREW_WRAPPER:-}" ]]
then
  DINRUSBREW_BREW_FILE="${DINRUSBREW_BREW_WRAPPER}"
fi

# These variables are exported in this file and are not allowed to be overridden by the user.
BIN_BREW_EXPORTED_VARS=(
  DINRUSBREW_BREW_FILE
  DINRUSBREW_PREFIX
  DINRUSBREW_REPOSITORY
  DINRUSBREW_LIBRARY
  DINRUSBREW_USER_CONFIG_HOME
  DINRUSBREW_ORIGINAL_BREW_FILE
)

# Load DinrusBrew's variable configuration files from disk.
export_homebrew_env_file() {
  local env_file

  env_file="${1}"
  [[ -r "${env_file}" ]] || return 0
  while read -r line
  do
    # only load DINRUSBREW_* lines
    [[ "${line}" = "DINRUSBREW_"* ]] || continue

    # forbid overriding variables that are set in this file
    local invalid_variable
    for VAR in "${BIN_BREW_EXPORTED_VARS[@]}"
    do
      [[ "${line}" = "${VAR}"* ]] && invalid_variable="${VAR}"
    done
    [[ -n "${invalid_variable:-}" ]] && continue

    export "${line?}"
  done <"${env_file}"
}

# First, load the system-wide configuration.
export_homebrew_env_file "/etc/homebrew/brew.env"

unset SYSTEM_ENV_TAKES_PRIORITY
if [[ -n "${DINRUSBREW_SYSTEM_ENV_TAKES_PRIORITY-}" ]]
then
  SYSTEM_ENV_TAKES_PRIORITY="1"
fi

# Next, load the prefix configuration
export_homebrew_env_file "${DINRUSBREW_PREFIX}/etc/homebrew/brew.env"

# Finally, load the user configuration
if [[ -n "${XDG_CONFIG_HOME-}" ]]
then
  DINRUSBREW_USER_CONFIG_HOME="${XDG_CONFIG_HOME}/homebrew"
else
  DINRUSBREW_USER_CONFIG_HOME="${HOME}/.homebrew"
fi

export_homebrew_env_file "${DINRUSBREW_USER_CONFIG_HOME}/brew.env"

# If the system configuration takes priority, load it again to override any previous settings.
if [[ -n "${SYSTEM_ENV_TAKES_PRIORITY-}" ]]
then
  export_homebrew_env_file "/etc/homebrew/brew.env"
fi

# Copy and export all DINRUSBREW_* variables previously mentioned in
# manpage or used elsewhere by DinrusBrew.

# These variables are allowed to be set by the user as, e.g., `DINRUSBREW_BROWSER`.
MANPAGE_VARS=(
  BAT_CONFIG_PATH
  BAT_THEME
  BROWSER
  BUNDLE_USER_CACHE
  DISPLAY
  EDITOR
  NO_COLOR
)
for VAR in "${MANPAGE_VARS[@]}"
do
  # Skip if variable value is empty.
  [[ -z "${!VAR:-}" ]] && continue

  VAR_NEW="DINRUSBREW_${VAR}"
  # Skip if existing DINRUSBREW_* variable is set.
  [[ -n "${!VAR_NEW:-}" ]] && continue
  export "${VAR_NEW}"="${!VAR}"
done

# We don't want to take the user's value for, e.g., `DINRUSBREW_PATH` here!
USED_BY_DINRUSBREW_VARS=(
  CODESPACES
  COLORTERM
  DBUS_SESSION_BUS_ADDRESS
  NODENV_ROOT
  PATH
  PYENV_ROOT
  RBENV_ROOT
  SSH_TTY
  SUDO_USER
  TMPDIR
  TMUX
  XDG_CACHE_HOME
  XDG_DATA_DIRS
  XDG_RUNTIME_DIR
  ZDOTDIR
)
for VAR in "${USED_BY_DINRUSBREW_VARS[@]}"
do
  # Skip if variable value is empty.
  [[ -z "${!VAR:-}" ]] && continue

  # We unconditionally override `DINRUSBREW_*` here.
  VAR_NEW="DINRUSBREW_${VAR}"
  export "${VAR_NEW}"="${!VAR}"
done

unset VAR VAR_NEW MANPAGE_VARS USED_BY_DINRUSBREW_VARS

for VAR in "${BIN_BREW_EXPORTED_VARS[@]}"
do
  export "${VAR?}"
done

# set from user environment
# shellcheck disable=SC2154
# Use VISUAL if DINRUSBREW_EDITOR and EDITOR are unset.
if [[ -z "${DINRUSBREW_EDITOR:-}" && -n "${VISUAL:-}" ]]
then
  export DINRUSBREW_EDITOR="${VISUAL}"
fi

# set from user environment
# shellcheck disable=SC2154
# Set CI variable for Azure Pipelines and Jenkins
# (Set by default on GitHub Actions, Circle and Travis CI)
if [[ -z "${CI:-}" ]] && [[ -n "${TF_BUILD:-}" || -n "${JENKINS_HOME:-}" ]]
then
  export CI="1"
fi

if [[ -n "${GITHUB_ACTIONS:-}" && -n "${ImageOS:-}" && -n "${ImageVersion:-}" ]]
then
  export DINRUSBREW_GITHUB_HOSTED_RUNNER=1
fi

# filter the user environment
PATH="/usr/bin:/bin:/usr/sbin:/sbin"

FILTERED_ENV=()
ENV_VAR_NAMES=(
  HOME SHELL PATH TERM TERMINFO TERMINFO_DIRS COLUMNS DISPLAY LOGNAME USER CI SSH_AUTH_SOCK SUDO_ASKPASS
  http_proxy https_proxy ftp_proxy no_proxy all_proxy HTTPS_PROXY FTP_PROXY ALL_PROXY
)
# Filter all but the specific variables.
for VAR in "${ENV_VAR_NAMES[@]}" "${!DINRUSBREW_@}"
do
  # Skip if variable value is empty.
  [[ -z "${!VAR:-}" ]] && continue

  FILTERED_ENV+=("${VAR}=${!VAR}")
done

if [[ -n "${CI:-}" ]]
then
  for VAR in "${!GITHUB_@}"
  do
    # Skip if variable value is empty.
    [[ -z "${!VAR:-}" ]] && continue
    # Skip variables that look like tokens.
    [[ "${VAR}" = *TOKEN* ]] && continue

    FILTERED_ENV+=("${VAR}=${!VAR}")
  done
fi

if [[ -n "${DINRUSBREW_RDBG:-}" ]]
then
  for VAR in "${!RUBY_DEBUG_@}"
  do
    # Skip if variable value is empty.
    [[ -z "${!VAR:-}" ]] && continue

    FILTERED_ENV+=("${VAR}=${!VAR}")
  done
fi

unset VAR ENV_VAR_NAMES

exec /usr/bin/env -i "${FILTERED_ENV[@]}" /bin/bash -p "${DINRUSBREW_LIBRARY}/DinrusBrew/brew.sh" "$@"
